<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'none'; style-src 'unsafe-inline' https://cdn.tailwindcss.com; script-src 'unsafe-inline' https://cdn.tailwindcss.com; font-src https://fonts.gstatic.com;"
    />
    <title>AI Dev Assistant Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      body {
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
      }

      .chat-container {
        height: calc(100vh - 120px);
      }

      /* Markdown styling */
      .markdown-content pre {
        background: #1e1e1e;
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 8px 0;
      }

      .markdown-content code {
        background: #2d2d2d;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Courier New", Consolas, Monaco, monospace;
        font-size: 0.9em;
      }

      .markdown-content pre code {
        background: transparent;
        padding: 0;
      }

      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3 {
        margin-top: 16px;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .markdown-content ul,
      .markdown-content ol {
        margin-left: 20px;
        margin-top: 8px;
        margin-bottom: 8px;
      }

      .markdown-content li {
        margin: 4px 0;
      }

      /* Buttons */
      .action-button {
        display: inline-block;
        margin-top: 8px;
        margin-right: 8px;
        padding: 6px 10px;
        background: #0066cc;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background 0.2s;
        word-break: keep-all;
      }

      .action-button:hover {
        background: #0052a3;
      }

      .action-button.danger {
        background: #c41e3a;
      }

      .action-button.danger:hover {
        background: #9e1830;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .animate-pulse {
        animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-thumb {
        background: #4a4a4a;
        border-radius: 4px;
      }

      /* Responsive tweaks */
      @media (max-width: 480px) {
        .chat-container {
          height: calc(100vh - 100px);
        }
        h1 {
          font-size: 1rem;
        }
        .action-button {
          font-size: 0.75rem;
          padding: 5px 8px;
        }
        #messageInput {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>

  <body class="bg-gray-900 text-gray-100 flex flex-col h-screen">
    <!-- Header -->
    <div
      class="p-3 sm:p-4 bg-gray-800 border-b border-gray-700 flex-shrink-0 flex flex-col"
    >
      <h1 class="text-lg sm:text-xl font-bold flex items-center flex-wrap">
        <span class="mr-2">ü§ñ</span> AI Dev Assistant
      </h1>
      <p class="text-xs text-gray-400 mt-1">
        Ask me about your code, debugging, or architecture.
      </p>
    </div>

    <!-- Messages area -->
    <div
      id="messages"
      class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-4 chat-container"
    >
      <div class="text-gray-400 text-sm text-center py-8">
        <div class="text-4xl mb-2">üí¨</div>
        <p>Start a conversation with your AI assistant</p>
        <p class="text-xs mt-2">
          I can help with code review, debugging, and more!
        </p>
      </div>
    </div>

    <!-- Thinking indicator -->
    <div
      id="thinking"
      class="hidden px-4 py-2 bg-gray-800 border-t border-gray-700 flex-shrink-0"
    >
      <div class="flex items-center space-x-2">
        <div class="animate-pulse text-blue-400 text-xl">‚óè</div>
        <span class="text-sm text-gray-400">AI is thinking...</span>
      </div>
    </div>

    <!-- Input area -->
    <div
      class="p-3 sm:p-4 bg-gray-800 border-t border-gray-700 flex-shrink-0 flex flex-col space-y-2"
    >
      <div class="flex flex-wrap space-2 gap-2 items-center justify-center">
        <input
          type="text"
          id="messageInput"
          placeholder="Ask me anything about your code..."
          class="flex-1 px-3 py-2 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-400 text-sm sm:text-base"
          autocomplete="off"
        />
        <button
          id="sendButton"
          class="px-4 sm:px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base whitespace-nowrap"
        >
          Send
        </button>
      </div>
      <div class="text-[10px] sm:text-xs text-gray-500">
        Tip: Open a file in the editor for context-aware assistance
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      const messagesDiv = document.getElementById("messages");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");
      const thinkingDiv = document.getElementById("thinking");
      let isFirstMessage = true;

      function addMessage(text, isUser = false) {
        if (isFirstMessage && isUser) {
          messagesDiv.innerHTML = "";
          isFirstMessage = false;
        }

        const wrapper = document.createElement("div");
        wrapper.className = isUser ? "flex justify-end" : "flex justify-start";

        const bubble = document.createElement("div");
        bubble.className = isUser
          ? "bg-blue-600 text-white px-3 sm:px-4 py-2 rounded-lg max-w-[90%] break-words text-sm sm:text-base"
          : "bg-gray-700 text-gray-100 px-3 sm:px-4 py-2 rounded-lg max-w-[90%] markdown-content break-words text-sm sm:text-base";

        if (isUser) bubble.textContent = text;
        else bubble.innerHTML = formatMarkdown(text);

        wrapper.appendChild(bubble);
        messagesDiv.appendChild(wrapper);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function formatMarkdown(text) {
        let formatted = text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        formatted = formatted.replace(
          /```(\w+)?\n([\s\S]*?)```/g,
          (_, lang, code) =>
            `<pre><code class="language-${
              lang || "code"
            }">${code.trim()}</code></pre>`
        );
        formatted = formatted.replace(/`([^`]+)`/g, "<code>$1</code>");
        formatted = formatted.replace(
          /\*\*([^*]+)\*\*/g,
          "<strong>$1</strong>"
        );
        formatted = formatted.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        formatted = formatted.replace(/^### (.+)$/gm, "<h3>$1</h3>");
        formatted = formatted.replace(/^## (.+)$/gm, "<h2>$1</h2>");
        formatted = formatted.replace(/^# (.+)$/gm, "<h1>$1</h1>");
        formatted = formatted.replace(/^\- (.+)$/gm, "<li>$1</li>");
        formatted = formatted.replace(/(<li>.*<\/li>)/s, "<ul>$1</ul>");
        formatted = formatted.replace(/\n/g, "<br>");
        return formatted;
      }

      function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;
        addMessage(text, true);
        vscode.postMessage({ type: "sendMessage", text });
        messageInput.value = "";
      }

      sendButton.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      window.addEventListener("message", (event) => {
        const message = event.data;
        if (message.type === "assistantMessage") addMessage(message.text);
        if (message.type === "assistantThinking")
          thinkingDiv.classList.toggle("hidden", !message.thinking);
        if (message.type === "error") addMessage(`‚ùå Error: ${message.text}`);
      });
    </script>
  </body>
</html>
